rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin (using custom claims)
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // ============================================
    // USER UPLOADS (Primary Structure)
    // ============================================
    // - Allow write only under /user_uploads/{uid}/... if request.auth.uid == uid
    // - Allow read if authenticated (user can read their own files)
    // - Allow admin full read/write
    match /user_uploads/{uid}/{allPaths=**} {
      allow read: if isAuthenticated() && (isOwner(uid) || isAdmin());
      allow write: if isOwner(uid) || isAdmin();
    }
    
    // ============================================
    // PROPERTIES IMAGES
    // ============================================
    // - Public read access
    // - Owner or admin can write (check ownership via Firestore if property exists)
    match /properties/{propertyId}/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if isAuthenticated() && (isAdmin() || 
                     // Allow if property doesn't exist yet (new property) OR user owns the property
                     !exists(/databases/(default)/documents/properties/$(propertyId)) ||
                     get(/databases/(default)/documents/properties/$(propertyId)).data.ownerId == request.auth.uid);
    }
    
    // ============================================
    // USER PROFILE IMAGES
    // ============================================
    // - Public read access
    // - Users can manage their own
    match /users/{userId}/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // SERVICE PROVIDER FILES
    // ============================================
    // - Public read access for approved providers
    // - Provider can manage their own files
    match /providers/{providerId}/{allPaths=**} {
      allow read: if true; // Public read access
      allow write: if isAuthenticated() && (isAdmin() ||
                     // Check if user owns the provider profile via Firestore
                     exists(/databases/(default)/documents/serviceProviders/$(providerId)) &&
                     get(/databases/(default)/documents/serviceProviders/$(providerId)).data.userId == request.auth.uid);
    }
    
    // ============================================
    // CONSTRUCTION PROJECT FILES
    // ============================================
    // - Authenticated users can read
    // - Owner can write
    match /construction_photos/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // RENOVATION PROJECT FILES
    // ============================================
    // - Authenticated users can read
    // - Owner can write
    match /renovation_photos/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // RENTAL PHOTOS
    // ============================================
    // - Authenticated users can read
    // - Owner can write
    match /rental_photos/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin();
    }
    
    // ============================================
    // DEFAULT DENY RULE
    // ============================================
    // Deny all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
