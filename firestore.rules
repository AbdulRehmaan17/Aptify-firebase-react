rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if user is admin or superadmin
    function isAdmin() {
      return isAuthenticated() && 
             (getUserRole() == 'admin' || getUserRole() == 'superadmin');
    }
    
    // Get user role from Firestore (more reliable than custom claims)
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Check if user is provider (constructor, renovator, or provider role)
    function isProvider() {
      return isAuthenticated() && 
             (getUserRole() == 'constructor' || 
              getUserRole() == 'renovator' || 
              getUserRole() == 'provider');
    }
    
    // Check if user owns a property
    function isPropertyOwner(propertyId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/properties/$(propertyId)) &&
             get(/databases/$(database)/documents/properties/$(propertyId)).data.ownerId == request.auth.uid;
    }
    
    // Check if user is involved in a project (client or provider)
    function isProjectParticipant(projectData) {
      return isAuthenticated() && 
             (projectData.userId == request.auth.uid ||
              projectData.clientId == request.auth.uid ||
              projectData.providerId == request.auth.uid);
    }
    
    // Check if user is a chat participant
    function isChatParticipant(chatData) {
      return isAuthenticated() && 
             request.auth.uid in chatData.participants;
    }
    
    // Validate required fields for user document
    function isValidUserDocument() {
      return request.resource.data.keys().hasAll(['uid', 'email', 'role']) &&
             request.resource.data.uid == request.auth.uid &&
             request.resource.data.email is string &&
             request.resource.data.role is string &&
             request.resource.data.role in ['user', 'provider', 'constructor', 'renovator', 'admin', 'superadmin'];
    }
    
    // Prevent modification of sensitive user fields
    function canModifyUserField(field) {
      // Users can modify their own non-sensitive fields
      let sensitiveFields = ['uid', 'role', 'walletBalance', 'totalBookings', 'totalReviews', 'createdAt'];
      return !(field in sensitiveFields) || isAdmin();
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can read their own document, admins can read all
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      
      // Users can create their own document with valid structure
      allow create: if isAuthenticated() && 
                       request.auth.uid == userId &&
                       isValidUserDocument() &&
                       request.resource.data.createdAt == request.time;
      
      // Users can update their own non-sensitive fields, admins can update anything
      allow update: if isAuthenticated() && 
                       (isOwner(userId) || isAdmin()) &&
                       // Prevent role escalation (users can't make themselves admin)
                       (isAdmin() || 
                        (request.resource.data.role == resource.data.role &&
                         request.resource.data.role != 'admin' &&
                         request.resource.data.role != 'superadmin')) &&
                       // Prevent UID modification
                       request.resource.data.uid == resource.data.uid &&
                       // Prevent wallet balance modification by non-admins
                       (isAdmin() || request.resource.data.walletBalance == resource.data.walletBalance);
      
      // Only admins can delete user documents
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SERVICE PROVIDERS COLLECTION
    // ============================================
    match /serviceProviders/{providerId} {
      // Anyone can read approved providers, providers can read their own
      allow read: if !isAuthenticated() && resource.data.isApproved == true ||
                     isAuthenticated() && 
                     (resource.data.isApproved == true || 
                      resource.data.userId == request.auth.uid ||
                      isAdmin());
      
      // Authenticated users can create provider profiles
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.createdAt == request.time;
      
      // Providers can update their own profile, admins can update any
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin()) &&
                       // Prevent userId modification
                       request.resource.data.userId == resource.data.userId &&
                       // Only admins can change approval status
                       (isAdmin() || request.resource.data.isApproved == resource.data.isApproved);
      
      // Only admins can delete provider profiles
      allow delete: if isAdmin();
    }
    
    // ============================================
    // PROPERTIES COLLECTION
    // ============================================
    match /properties/{propertyId} {
      // Public read for active properties, owners and admins can read all
      allow read: if !isAuthenticated() && resource.data.status == 'published' ||
                     isAuthenticated() && 
                     (resource.data.status == 'published' || 
                      resource.data.ownerId == request.auth.uid ||
                      isAdmin());
      
      // Authenticated users can create properties (they become owner)
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid &&
                       request.resource.data.createdAt == request.time;
      
      // Only property owners and admins can update
      allow update: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin()) &&
                       // Prevent ownerId modification
                       request.resource.data.ownerId == resource.data.ownerId;
      
      // Only property owners and admins can delete
      allow delete: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // CONSTRUCTION PROJECTS COLLECTION
    // ============================================
    match /constructionProjects/{projectId} {
      // Only participants and admins can read
      allow read: if isAuthenticated() && 
                     (isProjectParticipant(resource.data) || isAdmin());
      
      // Authenticated users can create projects (they become client)
      allow create: if isAuthenticated() && 
                       (request.resource.data.userId == request.auth.uid ||
                        request.resource.data.clientId == request.auth.uid) &&
                       request.resource.data.createdAt == request.time;
      
      // Only participants and admins can update
      allow update: if isAuthenticated() && 
                       (isProjectParticipant(resource.data) || isAdmin()) &&
                       // Prevent userId/clientId modification
                       (request.resource.data.userId == resource.data.userId &&
                        request.resource.data.clientId == resource.data.clientId);
      
      // Only clients and admins can delete
      allow delete: if isAuthenticated() && 
                       ((resource.data.userId == request.auth.uid ||
                         resource.data.clientId == request.auth.uid) ||
                        isAdmin());
      
      // Updates subcollection
      match /updates/{updateId} {
        allow read: if isAuthenticated() && 
                       (isProjectParticipant(get(/databases/$(database)/documents/constructionProjects/$(projectId)).data) ||
                        isAdmin());
        
        allow create: if isAuthenticated() && 
                         (isProjectParticipant(get(/databases/$(database)/documents/constructionProjects/$(projectId)).data) ||
                          isAdmin()) &&
                         request.resource.data.createdAt == request.time;
        
        // Only admins can modify/delete updates
        allow update, delete: if isAdmin();
      }
    }
    
    // ============================================
    // RENOVATION PROJECTS COLLECTION
    // ============================================
    match /renovationProjects/{projectId} {
      // Only participants and admins can read
      allow read: if isAuthenticated() && 
                     (isProjectParticipant(resource.data) || isAdmin());
      
      // Authenticated users can create projects (they become client)
      allow create: if isAuthenticated() && 
                       (request.resource.data.userId == request.auth.uid ||
                        request.resource.data.clientId == request.auth.uid) &&
                       request.resource.data.createdAt == request.time;
      
      // Only participants and admins can update
      allow update: if isAuthenticated() && 
                       (isProjectParticipant(resource.data) || isAdmin()) &&
                       // Prevent userId/clientId modification
                       (request.resource.data.userId == resource.data.userId &&
                        request.resource.data.clientId == resource.data.clientId);
      
      // Only clients and admins can delete
      allow delete: if isAuthenticated() && 
                       ((resource.data.userId == request.auth.uid ||
                         resource.data.clientId == request.auth.uid) ||
                        isAdmin());
      
      // Updates subcollection
      match /updates/{updateId} {
        allow read: if isAuthenticated() && 
                       (isProjectParticipant(get(/databases/$(database)/documents/renovationProjects/$(projectId)).data) ||
                        isAdmin());
        
        allow create: if isAuthenticated() && 
                         (isProjectParticipant(get(/databases/$(database)/documents/renovationProjects/$(projectId)).data) ||
                          isAdmin()) &&
                         request.resource.data.createdAt == request.time;
        
        // Only admins can modify/delete updates
        allow update, delete: if isAdmin();
      }
    }
    
    // ============================================
    // RENTAL REQUESTS COLLECTION
    // ============================================
    match /rentalRequests/{requestId} {
      // Only involved parties and admins can read
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid ||
                      isPropertyOwner(resource.data.propertyId) ||
                      isAdmin());
      
      // Authenticated users can create rental requests
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.createdAt == request.time;
      
      // Only involved parties and admins can update
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid ||
                        isPropertyOwner(resource.data.propertyId) ||
                        isAdmin()) &&
                       // Prevent userId modification
                       request.resource.data.userId == resource.data.userId;
      
      // Only request creator, property owner, and admins can delete
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid ||
                        isPropertyOwner(resource.data.propertyId) ||
                        isAdmin());
    }
    
    // ============================================
    // BUY/SELL REQUESTS COLLECTION
    // ============================================
    match /buySellRequests/{requestId} {
      // Only involved parties and admins can read
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid ||
                      isPropertyOwner(resource.data.propertyId) ||
                      isAdmin());
      
      // Authenticated users can create buy/sell requests
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.createdAt == request.time;
      
      // Only involved parties and admins can update
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid ||
                        isPropertyOwner(resource.data.propertyId) ||
                        isAdmin()) &&
                       // Prevent userId modification
                       request.resource.data.userId == resource.data.userId;
      
      // Only request creator, property owner, and admins can delete
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid ||
                        isPropertyOwner(resource.data.propertyId) ||
                        isAdmin());
    }
    
    // ============================================
    // RENTALS COLLECTION (Rental Properties)
    // ============================================
    match /rentals/{rentalId} {
      // Public read for active rentals, owners and admins can read all
      allow read: if !isAuthenticated() && resource.data.status == 'available' ||
                     isAuthenticated() && 
                     (resource.data.status == 'available' || 
                      resource.data.ownerId == request.auth.uid ||
                      isAdmin());
      
      // Authenticated users can create rentals (they become owner)
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid &&
                       request.resource.data.createdAt == request.time;
      
      // Only rental owners and admins can update
      allow update: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin()) &&
                       // Prevent ownerId modification
                       request.resource.data.ownerId == resource.data.ownerId;
      
      // Only rental owners and admins can delete
      allow delete: if isAuthenticated() && 
                       (resource.data.ownerId == request.auth.uid || isAdmin());
      
      // Bookings subcollection
      match /bookings/{bookingId} {
        allow read: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid ||
                        get(/databases/$(database)/documents/rentals/$(rentalId)).data.ownerId == request.auth.uid ||
                        isAdmin());
        
        allow create: if isAuthenticated() && 
                         request.resource.data.userId == request.auth.uid &&
                         request.resource.data.createdAt == request.time;
        
        allow update: if isAuthenticated() && 
                         (resource.data.userId == request.auth.uid ||
                          get(/databases/$(database)/documents/rentals/$(rentalId)).data.ownerId == request.auth.uid ||
                          isAdmin());
        
        allow delete: if isAuthenticated() && 
                         (resource.data.userId == request.auth.uid ||
                          get(/databases/$(database)/documents/rentals/$(rentalId)).data.ownerId == request.auth.uid ||
                          isAdmin());
      }
    }
    
    // ============================================
    // LISTINGS COLLECTION (Buy/Sell Marketplace)
    // ============================================
    match /listings/{listingId} {
      // Public read for active listings, owners and admins can read all
      allow read: if !isAuthenticated() && resource.data.status == 'active' ||
                     isAuthenticated() && 
                     (resource.data.status == 'active' || 
                      resource.data.sellerId == request.auth.uid ||
                      isAdmin());
      
      // Authenticated users can create listings (they become seller)
      allow create: if isAuthenticated() && 
                       request.resource.data.sellerId == request.auth.uid &&
                       request.resource.data.createdAt == request.time;
      
      // Only listing owners and admins can update
      allow update: if isAuthenticated() && 
                       (resource.data.sellerId == request.auth.uid || isAdmin()) &&
                       // Prevent sellerId modification
                       request.resource.data.sellerId == resource.data.sellerId;
      
      // Only listing owners and admins can delete
      allow delete: if isAuthenticated() && 
                       (resource.data.sellerId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // CHATS COLLECTION (User-to-User Chats)
    // ============================================
    match /chats/{chatId} {
      // Only participants and admins can read
      allow read: if isAuthenticated() && 
                     (isChatParticipant(resource.data) || isAdmin());
      
      // Authenticated users can create chats (must include themselves as participant)
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants &&
                       request.resource.data.createdAt == request.time;
      
      // Only participants and admins can update
      allow update: if isAuthenticated() && 
                       (isChatParticipant(resource.data) || isAdmin()) &&
                       // Prevent participant list modification by non-admins
                       (isAdmin() || request.resource.data.participants == resource.data.participants);
      
      // Only admins can delete chats
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                       (isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data) ||
                        isAdmin());
        
        allow create: if isAuthenticated() && 
                         isChatParticipant(get(/databases/$(database)/documents/chats/$(chatId)).data) &&
                         request.resource.data.senderId == request.auth.uid &&
                         request.resource.data.createdAt == request.time;
        
        // Users can only update/delete their own messages, admins can do all
        allow update, delete: if isAuthenticated() && 
                                 (resource.data.senderId == request.auth.uid || isAdmin());
      }
    }
    
    // ============================================
    // SUPPORT CHATS COLLECTION
    // ============================================
    match /supportChats/{chatId} {
      // Only chat participants (user or admin) and admins can read
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid ||
                      resource.data.adminId == request.auth.uid ||
                      isAdmin());
      
      // Authenticated users can create support chats
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.createdAt == request.time;
      
      // Only participants and admins can update
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid ||
                        resource.data.adminId == request.auth.uid ||
                        isAdmin());
      
      // Only admins can delete support chats
      allow delete: if isAdmin();
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                       (get(/databases/$(database)/documents/supportChats/$(chatId)).data.userId == request.auth.uid ||
                        get(/databases/$(database)/documents/supportChats/$(chatId)).data.adminId == request.auth.uid ||
                        isAdmin());
        
        allow create: if isAuthenticated() && 
                         (get(/databases/$(database)/documents/supportChats/$(chatId)).data.userId == request.auth.uid ||
                          get(/databases/$(database)/documents/supportChats/$(chatId)).data.adminId == request.auth.uid ||
                          isAdmin()) &&
                         request.resource.data.sender == request.auth.uid &&
                         request.resource.data.createdAt == request.time;
        
        // Users can only update/delete their own messages, admins can do all
        allow update, delete: if isAuthenticated() && 
                                 (resource.data.sender == request.auth.uid || isAdmin());
      }
    }
    
    // ============================================
    // NOTIFICATIONS COLLECTION
    // ============================================
    match /notifications/{notificationId} {
      // Only target user and admins can read
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      // Only system (via admin functions) can create notifications
      allow create: if isAdmin();
      
      // Only target user and admins can update (e.g., mark as read)
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin()) &&
                       // Prevent userId modification
                       request.resource.data.userId == resource.data.userId;
      
      // Only target user and admins can delete
      allow delete: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // ============================================
    // REVIEWS COLLECTION
    // ============================================
    match /reviews/{reviewId} {
      // Public read access
      allow read: if true;
      
      // Users can create reviews for services/products they've interacted with
      // Note: Service completion verification should be done in application logic
      // Rules here ensure users can only create reviews with their own ID
      allow create: if isAuthenticated() && 
                       (request.resource.data.reviewerId == request.auth.uid ||
                        request.resource.data.authorId == request.auth.uid) &&
                       request.resource.data.createdAt == request.time;
      
      // Only reviewer and admins can update
      allow update: if isAuthenticated() && 
                       ((resource.data.reviewerId == request.auth.uid ||
                         resource.data.authorId == request.auth.uid) ||
                        isAdmin()) &&
                       // Prevent reviewerId/authorId modification
                       (request.resource.data.reviewerId == resource.data.reviewerId &&
                        request.resource.data.authorId == resource.data.authorId);
      
      // Only reviewer and admins can delete
      allow delete: if isAuthenticated() && 
                       ((resource.data.reviewerId == request.auth.uid ||
                         resource.data.authorId == request.auth.uid) ||
                        isAdmin());
    }
    
    // ============================================
    // TRANSACTIONS COLLECTION
    // ============================================
    match /transactions/{transactionId} {
      // Only transaction owner and admins can read
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      // Only system (via admin functions) can create transactions
      allow create: if isAdmin();
      
      // Only admins can update transactions
      allow update: if isAdmin();
      
      // Only admins can delete transactions
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ORDERS COLLECTION (E-commerce)
    // ============================================
    match /orders/{orderId} {
      // Only order owner and admins can read
      allow read: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isAdmin());
      
      // Authenticated users can create orders
      allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.createdAt == request.time;
      
      // Only order owner and admins can update
      allow update: if isAuthenticated() && 
                       (resource.data.userId == request.auth.uid || isAdmin()) &&
                       // Prevent userId modification
                       request.resource.data.userId == resource.data.userId;
      
      // Only admins can delete orders
      allow delete: if isAdmin();
    }
    
    // ============================================
    // PRODUCTS COLLECTION (E-commerce)
    // ============================================
    match /products/{productId} {
      // Public read for active products, admins can read all
      allow read: if !isAuthenticated() && resource.data.status == 'published' ||
                     isAuthenticated() && 
                     (resource.data.status == 'published' || isAdmin());
      
      // Only admins can create products
      allow create: if isAdmin() && 
                       request.resource.data.createdAt == request.time;
      
      // Only admins can update products
      allow update: if isAdmin();
      
      // Only admins can delete products
      allow delete: if isAdmin();
    }
    
    // ============================================
    // BRANDS COLLECTION (E-commerce)
    // ============================================
    match /brands/{brandId} {
      // Public read access
      allow read: if true;
      
      // Only admins can create/update/delete brands
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // COLLECTIONS COLLECTION (E-commerce)
    // ============================================
    match /collections/{collectionId} {
      // Public read access
      allow read: if true;
      
      // Only admins can create/update/delete collections
      allow create, update, delete: if isAdmin();
    }
    
    // ============================================
    // DEFAULT DENY RULE
    // ============================================
    // Deny all other collections by default (security best practice)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
